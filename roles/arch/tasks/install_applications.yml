- name: Install applications via Pacman
  loop: "{{ applications }}"
  when:
    - item.arch is defined
    - item.arch.source == 'pacman'
  community.general.pacman:
    name: "{{ item.arch.name | default(item.name) }}"
    state: present # Pacman packages will be updated holistically in a separate task.
  become: true

- name: Install applications via Paru
  loop: "{{ applications }}"
  when:
    - item.arch is defined
    - item.arch.source == 'paru'
  kewlfft.aur.aur:
    use: paru
    name: "{{ item.arch.name | default(item.name) }}"
    state: present # Paru packages will be updated holistically in a separate task.
  become: true
  become_user: aur_builder

- name: Install applications via Flatpak
  loop: "{{ applications }}"
  when:
    - item.arch is defined
    - item.arch.source == 'flatpak'
  community.general.flatpak:
    name: "{{ item.arch.name | default(item.name) }}"
    state: latest # Flatpak packages will be updated piecemeal.
  become: false

- name: Install applications via shell script
  loop: "{{ applications }}"
  when:
    - item.arch is defined
    - item.arch.source == 'script'
    - item.arch.script_name is defined
  ansible.builtin.script:
    cmd: "{{ item.arch.script_name }}"
    creates: "{{ item.arch.creates | default(omit) }}"
  become: true
